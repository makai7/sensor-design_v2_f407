# å•å…ƒæµ‹è¯•æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† STM32F407 æ™ºèƒ½äº‘å°ç³»ç»Ÿçš„åµŒå…¥å¼å•å…ƒæµ‹è¯•æ¡†æ¶ã€‚

## æµ‹è¯•æ¡†æ¶ç‰¹æ€§

### âœ… è½»é‡çº§åµŒå…¥å¼æµ‹è¯•æ¡†æ¶
- æ— éœ€å¤–éƒ¨ä¾èµ–åº“
- åŸºäº UART è¾“å‡ºæµ‹è¯•ç»“æœ
- æ”¯æŒæ•´æ•°å’Œæµ®ç‚¹æ•°æ–­è¨€
- è‡ªåŠ¨ç»Ÿè®¡æµ‹è¯•é€šè¿‡/å¤±è´¥æ•°é‡

### ğŸ“ æµ‹è¯•æ–­è¨€å®

```c
// åŸºç¡€æ–­è¨€
TEST_ASSERT(condition, message)

// æ•´æ•°ç›¸ç­‰æ–­è¨€
TEST_ASSERT_EQUAL(expected, actual, message)

// æµ®ç‚¹æ•°ç›¸ç­‰æ–­è¨€ï¼ˆå¸¦å®¹å·®ï¼‰
TEST_ASSERT_FLOAT_EQUAL(expected, actual, tolerance, message)
```

## å·²å®ç°çš„æµ‹è¯•ç”¨ä¾‹

### 1. èˆµæœºè§’åº¦è½¬æ¢æµ‹è¯• (`Test_Servo_AngleToPulse`)

æµ‹è¯• `Servo_AngleToPulse()` å‡½æ•°çš„æ­£ç¡®æ€§ã€‚

**æµ‹è¯•ç”¨ä¾‹ï¼š**

| è¾“å…¥è§’åº¦ | æœŸæœ› PWM è„‰å®½ | è¯´æ˜ |
|---------|--------------|------|
| 0Â°      | 500          | æœ€å°è§’åº¦ |
| 45Â°     | 1000         | å››åˆ†ä¹‹ä¸€ |
| 90Â°     | 1500         | ä¸­é—´ä½ç½® |
| 135Â°    | 2000         | å››åˆ†ä¹‹ä¸‰ |
| 180Â°    | 2500         | æœ€å¤§è§’åº¦ |
| -10Â°    | 500          | è´Ÿå€¼æˆªæ–­åˆ° 0Â° |
| 200Â°    | 2500         | è¶…èŒƒå›´æˆªæ–­åˆ° 180Â° |

**å…¬å¼ï¼š**
```
PWMè„‰å®½ = 500 + (è§’åº¦ / 180) Ã— 2000
```

### 2. è¶…å£°æ³¢è·ç¦»è½¬æ¢æµ‹è¯• (`Test_HCSR04_PulseToDistance`)

æµ‹è¯• `HCSR04_PulseToDistance()` å‡½æ•°çš„æ­£ç¡®æ€§ã€‚

**æµ‹è¯•ç”¨ä¾‹ï¼š**

| è¾“å…¥è„‰å®½ (Î¼s) | æœŸæœ›è·ç¦» (cm) | å®¹å·® | è¯´æ˜ |
|--------------|--------------|------|------|
| 0            | 0.0          | 0.01 | é›¶è·ç¦» |
| 100          | 1.7          | 0.1  | è¿‘è·ç¦» |
| 1000         | 17.0         | 0.1  | çŸ­è·ç¦» |
| 2000         | 34.0         | 0.1  | ä¸­ç­‰è·ç¦» |
| 5882         | 100.0        | 0.5  | 1ç±³ |
| 11764        | 200.0        | 1.0  | 2ç±³ |

**å…¬å¼ï¼š**
```
è·ç¦» (cm) = è„‰å®½ (Î¼s) Ã— 0.017
```

**ç‰©ç†åŸç†ï¼š**
- å£°é€Ÿ = 340 m/s = 0.034 cm/Î¼s
- å¾€è¿”è·ç¦» = æ—¶é—´ Ã— 0.034
- å•ç¨‹è·ç¦» = å¾€è¿”è·ç¦» / 2 = æ—¶é—´ Ã— 0.017

## æµ‹è¯•æ‰§è¡Œæµç¨‹

### ç³»ç»Ÿå¯åŠ¨æ—¶çš„æµ‹è¯•åºåˆ—

```
1. ç³»ç»Ÿåˆå§‹åŒ– (HAL, æ—¶é’Ÿé…ç½®)
2. å¤–è®¾åˆå§‹åŒ– (UART, I2C, TIM, DCMI)
3. âœ… è¿è¡Œå•å…ƒæµ‹è¯• (Run_All_Tests)
4. åˆå§‹åŒ–åº”ç”¨å±‚é©±åŠ¨
5. è¿›å…¥ä¸»å¾ªç¯
```

### é¢„æœŸæµ‹è¯•è¾“å‡º

```
========================================
 STM32F407 Smart Gimbal System
 Firmware Version: 1.0
========================================

========================================
 EMBEDDED UNIT TEST SUITE
========================================

Running: Servo Angle to Pulse Conversion...
  [PASS] Servo Angle to Pulse Conversion

Running: HC-SR04 Pulse to Distance Conversion...
  [PASS] HC-SR04 Pulse to Distance Conversion

========================================
 TEST SUMMARY
========================================
Total Tests:  2
Passed:       2
Failed:       0

*** ALL TESTS PASSED ***
========================================

[INIT] Initializing servos...
[OK] Servos initialized
...
```

## æµ‹è¯•å¤±è´¥ç¤ºä¾‹

å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œä¼šè¾“å‡ºè¯¦ç»†çš„å¤±è´¥ä¿¡æ¯ï¼š

```
Running: Servo Angle to Pulse Conversion...
  [FAIL] servo_driver.c:35 - 0 degree should return 500
  [FAIL] Servo Angle to Pulse Conversion

========================================
 TEST SUMMARY
========================================
Total Tests:  2
Passed:       1
Failed:       1

*** 1 TEST(S) FAILED ***
========================================
```

## æ·»åŠ æ–°æµ‹è¯•ç”¨ä¾‹

### æ­¥éª¤ 1: åœ¨ `test_suite.h` ä¸­å£°æ˜

```c
bool Test_YourNewFunction(void);
```

### æ­¥éª¤ 2: åœ¨ `test_suite.c` ä¸­å®ç°

```c
bool Test_YourNewFunction(void)
{
    uint32_t result;

    /* Test case 1 */
    result = YourFunction(input1);
    TEST_ASSERT_EQUAL(expected1, result, "Test case 1 description");

    /* Test case 2 */
    result = YourFunction(input2);
    TEST_ASSERT_EQUAL(expected2, result, "Test case 2 description");

    return true;
}
```

### æ­¥éª¤ 3: åœ¨ `Run_All_Tests()` ä¸­æ·»åŠ è°ƒç”¨

```c
void Run_All_Tests(void)
{
    // ... existing code ...

    Run_Single_Test(Test_YourNewFunction, "Your New Function Test");

    // ... existing code ...
}
```

## ä»£ç é‡æ„è¯´æ˜

ä¸ºäº†æ”¯æŒå•å…ƒæµ‹è¯•ï¼Œä»¥ä¸‹å‡½æ•°è¢«é‡æ„ä¸ºçº¯è®¡ç®—å‡½æ•°ï¼š

### 1. `Servo_AngleToPulse()` - servo_driver.c

**é‡æ„å‰ï¼š** è®¡ç®—é€»è¾‘å†…åµŒåœ¨ `Servo_SetAngle()` ä¸­

**é‡æ„åï¼š** ç‹¬ç«‹çš„çº¯å‡½æ•°ï¼Œä¸ä¾èµ–ç¡¬ä»¶
```c
uint16_t Servo_AngleToPulse(float angle);
```

### 2. `HCSR04_PulseToDistance()` - hcsr04.c

**é‡æ„å‰ï¼š** è®¡ç®—é€»è¾‘å†…åµŒåœ¨ä¸­æ–­å›è°ƒä¸­

**é‡æ„åï¼š** ç‹¬ç«‹çš„çº¯å‡½æ•°ï¼Œä¸ä¾èµ–ç¡¬ä»¶
```c
float HCSR04_PulseToDistance(uint32_t pulseWidth_us);
```

## ä¼˜åŠ¿

âœ… **æ—©æœŸé”™è¯¯æ£€æµ‹** - åœ¨ç¡¬ä»¶åˆå§‹åŒ–å‰å‘ç°é€»è¾‘é”™è¯¯

âœ… **å›å½’æµ‹è¯•** - ç¡®ä¿ä»£ç ä¿®æ”¹ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½

âœ… **å¯ç§»æ¤æ€§** - çº¯è®¡ç®—å‡½æ•°å¯åœ¨ PC ä¸Šç‹¬ç«‹æµ‹è¯•

âœ… **æ–‡æ¡£åŒ–** - æµ‹è¯•ç”¨ä¾‹å³ä¸ºå‡½æ•°è¡Œä¸ºçš„è§„èŒƒ

âœ… **ç¬¦åˆ CubeMX è§„èŒƒ** - æ‰€æœ‰æµ‹è¯•ä»£ç ä½äº USER CODE åŒºåŸŸ

## é™åˆ¶

âš ï¸ **ä¸æµ‹è¯•ç¡¬ä»¶äº¤äº’** - ä»…æµ‹è¯•çº¯è®¡ç®—é€»è¾‘

âš ï¸ **éœ€è¦ UART è¾“å‡º** - ä¾èµ–ä¸²å£è°ƒè¯•

âš ï¸ **æ‰‹åŠ¨éªŒè¯** - éœ€è¦äººå·¥æŸ¥çœ‹ä¸²å£è¾“å‡º

## æœªæ¥æ”¹è¿›

- [ ] æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼ˆPC ç«¯è§£æ UART è¾“å‡ºï¼‰
- [ ] å¢åŠ æ›´å¤šè¾¹ç•Œæ¡ä»¶æµ‹è¯•
- [ ] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] æ”¯æŒ OV2640 å›¾åƒéªŒè¯æµ‹è¯•ï¼ˆéœ€è¦é¢å¤–å·¥å…·ï¼‰
- [ ] é›†æˆæŒç»­é›†æˆ (CI) æµç¨‹

---

## å‚è€ƒ

- **æµ‹è¯•æ¡†æ¶ä»£ç **: `Core/Inc/test_suite.h`, `Core/Src/test_suite.c`
- **è¢«æµ‹é©±åŠ¨**: `servo_driver.c`, `hcsr04.c`
- **é›†æˆä½ç½®**: `main.c` (åœ¨ `USER CODE BEGIN 2` ä¸­è°ƒç”¨)
